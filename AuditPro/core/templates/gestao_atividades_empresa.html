<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gestão de Atividades - {{ empresa.sigla }} ({{ ano }})</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .modal-bg-custom { background: #00000066; }
        .table-atividades th, .table-atividades td { vertical-align: middle; }
        .required { color: #d32f2f; font-weight: bold; }
        .overflow-max { max-height: 220px; overflow-y: auto; border:1px solid #eee; padding:10px; border-radius:8px; }
        .sticky-top-filtros { position:sticky; top:0; background: #fafbfc; z-index:10; }
        .edit-field { width: 100%; min-width: 110px; }
        th.col-categoria, td.col-categoria { min-width: 150px; width: 160px; }
        th.col-subitem, td.col-subitem { min-width: 180px; width: 200px; }
        th.col-inicio, td.col-inicio { min-width: 90px; width: 100px; }
        th.col-fim, td.col-fim { min-width: 90px; width: 100px; }
        th.col-status, td.col-status { min-width: 160px; width: 170px; }
        th.col-usuario, td.col-usuario { min-width: 110px; width: 120px; }
        th.col-atividade, td.col-atividade { min-width: 260px; width: 270px; }
        th.col-prazo, td.col-prazo { min-width: 50px; width: 60px; }
        th.col-dataconc, td.col-dataconc { min-width: 150px; width: 160px; }
        th.col-periodo, td.col-periodo { min-width: 120px; width: 130px; }
        th select, th input { width: 100%; min-width: 0 !important; }
    </style>
</head>
<body>
    <div class="py-5" style="width: 90%; margin: 0 auto;">
        <h2 class="mb-4 fw-bold" style="color:#d32f2f;">
            {{ empresa.nome_fantasia|default:empresa.razao_social }} <small class="text-muted">({{ empresa.sigla }})</small>
        </h2>
        <div class="mb-3">
            <span class="fw-bold">Exercício:</span> {{ ano }}
        </div>
        <button class="btn btn-outline-danger mb-4" data-bs-toggle="modal" data-bs-target="#importarModal">
            Importar Atividades
        </button>

        <div class="table-responsive">
            <table class="table table-bordered table-atividades align-middle mt-4" id="atividades-table">
                <thead class="table-light">
                    <tr>
                        <th class="col-periodo">Período
                            <select class="form-select form-select-sm mt-1" onchange="filterTable()" id="filter-periodo">
                                <option value="">Todos</option>
                                {% for per in periodos %}
                                <option value="{{ per }}">{{ per }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th class="col-categoria">Categoria
                            <select class="form-select form-select-sm mt-1" onchange="filterTable()" id="filter-categoria">
                                <option value="">Todas</option>
                                {% for categoria in categorias %}
                                <option value="{{ categoria.nome }}">{{ categoria.nome }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th class="col-subitem">Subitem
                            <select class="form-select form-select-sm mt-1" onchange="filterTable()" id="filter-subitem">
                                <option value="">Todos</option>
                                {% for categoria in categorias %}
                                  {% for subitem in categoria.subitens.all %}
                                    <option value="{{ subitem.nome }}">{{ subitem.nome }}</option>
                                  {% endfor %}
                                {% endfor %}
                            </select>
                        </th>
                        <th class="col-atividade">Atividade
                            <input class="form-control form-control-sm mt-1" type="text" placeholder="Filtrar..." onkeyup="filterTable()" id="filter-atividade">
                        </th>
                        <th class="col-prazo">Prazo</th>
                        <th class="col-inicio">Início</th>
                        <th class="col-fim">Fim</th>
                        <th class="col-status">Status
                            <select class="form-select form-select-sm mt-1" onchange="filterTable()" id="filter-status">
                                <option value="">Todos</option>
                                {% for st in status_choices %}
                                <option value="{{ st }}">{{ st }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th class="col-usuario">Usuário
                            <select class="form-select form-select-sm mt-1" onchange="filterTable()" id="filter-usuario">
                                <option value="">Todos</option>
                                {% for user in usuarios %}
                                <option value="{{ user.sigla }}">{{ user.sigla }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th class="col-dataconc">Data de Conclusão
                            <input class="form-control form-control-sm mt-1" type="date" onchange="filterTable()" id="filter-data-fim">
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for ae in atividades_importadas %}
                    <tr>
                        <td>{{ ae.periodo|default:"—" }}</td>
                        <td>{{ ae.categoria.nome }}</td>
                        <td>{{ ae.subitem.nome }}</td>
                        <td>{{ ae.atividade.nome }}</td>
                        <td>{{ ae.prazo|default:ae.atividade.tempo_estimado|default:"—" }}</td>
                        <td>{% if ae.data_inicio %}{{ ae.data_inicio|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                        <td>{% if ae.data_fim %}{{ ae.data_fim|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                        <td>
                            <form method="post">{% csrf_token %}
                                <select name="status" class="form-select form-select-sm edit-field" onchange="this.form.submit()">
                                    {% for status in status_choices %}
                                    <option value="{{ status }}" {% if ae.status == status %}selected{% endif %}>{{ status }}</option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" name="editar_status_id" value="{{ ae.id }}">
                            </form>
                        </td>
                        <td>
                            <form method="post">{% csrf_token %}
                                <select name="usuario_sigla" class="form-select form-select-sm edit-field" onchange="this.form.submit()">
                                    {% for user in usuarios %}
                                    <option value="{{ user.sigla }}" {% if ae.usuario.sigla == user.sigla %}selected{% endif %}>{{ user.sigla }}</option>
                                    {% endfor %}
                                </select>
                                <input type="hidden" name="editar_usuario_id" value="{{ ae.id }}">
                            </form>
                        </td>
                        <td>
                            <form method="post">{% csrf_token %}
                                <input type="date" name="data_conclusao" class="form-control form-control-sm edit-field"
                                       value="{% if ae.data_fim %}{{ ae.data_fim|date:'Y-m-d' }}{% endif %}" onchange="this.form.submit()">
                                <input type="hidden" name="editar_data_fim_id" value="{{ ae.id }}">
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="10" class="text-center text-muted">Nenhuma atividade importada para esta empresa.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <a href="{% url 'atividades' ano=ano %}" class="btn btn-outline-danger mt-4">Voltar para lista de empresas</a>
    </div>

    <!-- Modal Importar Atividades -->
    <div class="modal fade" id="importarModal" tabindex="-1" aria-labelledby="importarModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <form method="post" id="importarForm">
            {% csrf_token %}
            <div class="modal-header">
              <h5 class="modal-title" id="importarModalLabel">Importar Atividades</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label class="fw-bold mb-1 required">Selecione Categorias/Subitens/Atividades:</label>
                  <div class="overflow-max">
                    {% for categoria in categorias %}
                        <div>
                            <input type="checkbox" id="cat{{ categoria.id }}" class="categoria-chk" onclick="toggleCategoria('cat{{ categoria.id }}')">
                            <label for="cat{{ categoria.id }}" class="fw-bold">{{ categoria.nome }}</label>
                        </div>
                        {% for subitem in categoria.subitens.all %}
                            <div class="ms-3">
                                <input type="checkbox" id="sub{{ subitem.id }}" class="subitem-chk cat-cat{{ categoria.id }}" onclick="toggleSubitem('sub{{ subitem.id }}')">
                                <label for="sub{{ subitem.id }}" class="fw-normal">{{ subitem.nome }}</label>
                            </div>
                            {% for atividade in subitem.atividades.all %}
                                <div class="ms-5">
                                    <input type="checkbox" 
                                           id="atv{{ atividade.id }}" 
                                           class="atividade-chk sub-sub{{ subitem.id }} cat-cat{{ categoria.id }}" 
                                           name="atividades_importadas" value="{{ atividade.id }}">
                                    <label for="atv{{ atividade.id }}">{{ atividade.nome }}</label>
                                    {% if atividade.tempo_estimado %}
                                        <small class="text-muted">({{ atividade.tempo_estimado }})</small>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        {% endfor %}
                        <hr class="my-2">
                    {% empty %}
                        <div class="text-muted">Nenhuma categoria cadastrada.</div>
                    {% endfor %}
                  </div>
                  <button type="button" class="btn btn-link ps-0 pt-2" onclick="marcarTodosAtividades(true)">Marcar todos</button>
                  <button type="button" class="btn btn-link ps-0 pt-2" onclick="marcarTodosAtividades(false)">Desmarcar todos</button>
                </div>
                <div class="col-md-6">
                  <label class="fw-bold mb-1 required">Período:</label>
                  <div class="mb-2">
                    <select name="periodo" class="form-select" onchange="handlePeriodoSelect(this)">
                        <option value="">Selecione o período</option>
                        {% for per in periodos %}
                        <option>{{ per }}</option>
                        {% endfor %}
                    </select>
                  </div>
                  <div class="mb-2">ou escolha datas personalizadas:</div>
                  <div class="row">
                    <div class="col">
                      <input type="date" name="data_inicio" class="form-control" onchange="clearPeriodoSelect(this)">
                    </div>
                    <div class="col">
                      <input type="date" name="data_fim" class="form-control" onchange="clearPeriodoSelect(this)">
                    </div>
                  </div>
                  <div class="mt-4">
                    <label class="fw-bold required">Usuário responsável:</label>
                    <select name="usuario_sigla" class="form-select" required>
                        <option value="">Selecione...</option>
                        {% for user in usuarios %}
                        <option value="{{ user.sigla }}">{{ user.sigla }}</option>
                        {% endfor %}
                    </select>
                  </div>
                  <!-- CAMPO NOVO: Atividade Inicial -->
                  <div class="mt-4">
                    <label class="fw-bold required">Atividade Inicial?</label>
                    <select name="atividade_inicial" class="form-select">
                        <option value="NÃO" selected>Não</option>
                        <option value="SIM">Sim</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="alert alert-info mt-3">
                <b>Obs:</b> Marque as atividades que deseja importar. Só é permitido informar <u>período OU datas</u>. Todas novas atividades começam como <b>Não Iniciado</b>.
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-danger">Importar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Hierarchical checkbox logic
        function toggleCategoria(catId) {
            let check = document.getElementById(catId).checked;
            document.querySelectorAll('.cat-' + catId).forEach(function(cb) {
                cb.checked = check;
                cb.dispatchEvent(new Event('change'));
            });
        }
        function toggleSubitem(subId) {
            let check = document.getElementById(subId).checked;
            document.querySelectorAll('.sub-' + subId).forEach(function(cb) {
                cb.checked = check;
            });
        }
        function marcarTodosAtividades(valor) {
            document.querySelectorAll('.categoria-chk, .subitem-chk, .atividade-chk').forEach(function(cb) {
                cb.checked = valor;
            });
        }
        function clearPeriodoSelect(el) {
            if (el.value) document.querySelector('select[name="periodo"]').value = '';
        }
        function handlePeriodoSelect(sel) {
            if (sel.value) {
                document.querySelector('input[name="data_inicio"]').value = '';
                document.querySelector('input[name="data_fim"]').value = '';
            }
        }
        function filterTable() {
            let table = document.getElementById('atividades-table');
            let inputs = [
                document.getElementById('filter-periodo'),
                document.getElementById('filter-categoria'),
                document.getElementById('filter-subitem'),
                document.getElementById('filter-atividade'),
                null, null, null,
                document.getElementById('filter-status'),
                document.getElementById('filter-usuario'),
                document.getElementById('filter-data-fim'),
            ];
            let rows = table.querySelectorAll('tbody tr');

            rows.forEach(tr => {
                let tds = tr.children;
                let mostrar = true;

                if (inputs[0] && inputs[0].value && tds[0].textContent.trim() != inputs[0].value) mostrar = false;
                if (inputs[1] && inputs[1].value && tds[1].textContent.trim() != inputs[1].value) mostrar = false;
                if (inputs[2] && inputs[2].value && tds[2].textContent.trim() != inputs[2].value) mostrar = false;
                if (inputs[3] && inputs[3].value && !tds[3].textContent.toLowerCase().includes(inputs[3].value.toLowerCase())) mostrar = false;
                if (inputs[7] && inputs[7].value) {
                    let statusEl = tds[7].querySelector('select');
                    if (statusEl && statusEl.value !== inputs[7].value) mostrar = false;
                }
                if (inputs[8] && inputs[8].value) {
                    let userEl = tds[8].querySelector('select');
                    if (userEl && userEl.value !== inputs[8].value) mostrar = false;
                }
                if (inputs[9] && inputs[9].value) {
                    let dataEl = tds[9].querySelector('input[type="date"]');
                    if (dataEl && dataEl.value !== inputs[9].value) mostrar = false;
                }
                tr.style.display = mostrar ? "" : "none";
            });
        }
    </script>
</body>
</html>
